
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Questions</title>
</head>
<body>


<div id="question">
</div>
<div id="score"></div>
<form id="answer" onsubmit="getQuestion()"><input type="text" id="inputField" ><input type="submit"></form>
<button id="skipButton">Skip</button>
<script>
    var cookies1 = document.cookie;
    console.log(cookies1);
    function getCookieValue(cookieName){
        let array = cookieName.split("; ");
        for(let i=0; i < array.length; i++){
            let cookie = array[i];
            let [name,value] =  cookie.split("=");
            if (name == "session"){
                return value;
            }
        }

    }
    let sessionID = getCookieValue(cookies1);

    let skip =  document.getElementById('skipButton')
    skip.addEventListener('click',skipped);


    let question = document.getElementById('question');
    let formElement = document.getElementById('answer');

    async function locationK(){
        function askForLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
            else {
                //TODO - Geolocation is NOT supported by browser.
            }
        }

        let latitude = "";
        let longitude = "";
        async function showPosition(position) {
            latitude = position.coords.latitude //Get the latitude
            longitude = position.coords.longitude //Get the longitude

            await fetch("https://codecyprus.org/th/api/location?session=" + sessionID + "&latitude=" + latitude + "&longitude=" + longitude)
                .then(response => response.json())
                .then(jsonObject => {
                    console.log(jsonObject);
                });
        }
        askForLocation();

    }
    locationK();
    setInterval(locationK, 35000);
    let scoreElement = document.getElementById('score');
    async function getScore(){
        await fetch("https://codecyprus.org/th/api/score?session=" + sessionID)
            .then(response => response.json())
            .then(jsonObject => {
                scoreElement.innerText = "Score: " + jsonObject.score;
            });
    }

    //receive the question information and display the question
    function getQuestion() {
        fetch("https://codecyprus.org/th/api/question?session=" + sessionID).then(response => response.json())
            .then(async jsonObject => {
                console.log(jsonObject);
                question.innerHTML = jsonObject.questionText;
                if (jsonObject.requiresLocation == true) {
                    alert("We need your location for this question");
                    await locationK();
                }
                if (jsonObject.canBeSkipped == false) {
                    skip.disabled = true;
                } else {
                    skip.disabled = false;
                }
            });

    }
    getScore();
    getQuestion();
    formElement.addEventListener('submit', getAnswer);
    //function to retrieve the answer and send it to the api to see if it's correct
    async function getAnswer(){
        //prevent the submission of the form so the page doesn't reload so we don't loose the session id from the url
        let answer = document.getElementById('inputField').value;
        document.getElementById("inputField").value = "";
        //check if the user's answer is correct
        await fetch("https://codecyprus.org/th/api/answer?session=" + sessionID  + "&answer=" + answer)
            .then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject);
                if(jsonObject.complete == false ){
                    getScore();
                    getQuestion();
                }
            });
        window.location.reload();
    }

    async function skipped(){
        await fetch("https://codecyprus.org/th/api/skip?session=" + sessionID)
            .then(response => response.json())
            .then(jsonObject => {
                getQuestion();
                getScore();
            });
        window.location.reload();
    }



</script>
</body>
</html>