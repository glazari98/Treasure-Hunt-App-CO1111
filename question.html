
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="questions.css" />

    <title>Questions</title>
    <script src="js/instascan.min.js"></script>
    <script src="https://kit.fontawesome.com/a28250db7a.js" crossorigin="anonymous"></script>
</head>
<body>
<header>
    <div  class="navigation">
        <ul>
            <li><a href="leaderboard.html">Leaderboard</a></li>

            <li><button id="QR" onclick="QR()"><i class="fa-solid fa-qrcode"></i></button></li>
            <li id="score">Score:
                <label id="scoreNumber"></label></li>
            <li id="timer"></li>
        </ul>

    </div>


</header>
<main>
    <div id="question">
</div>

<form id="answer" onsubmit="getQuestion()">
    <div id="answerField"></div>
    <div id="submitB"><input type="submit"  id="sub"></div>
</form>

<button id="skipButton">Skip</button>


<h1 id='pleaseWaitMessage' style="display: none;">PLEASE WAIT ...</h1>
</main>
<footer>Copyright Â© 2024 UCLan Cyprus, All rights reserved. </footer>
<!-- <video id="preview"></video> -->
<script>

    function QR () {

        var opts = {// Whether to scan continuously for QR codes. If false, use scanner.scan() to
            // manually scan. If true, the scanner emits the "scan" event when a QR code is
            // scanned. Default true.
                continuous: true,
            // The HTML element to use for the camera's video preview. Must be a <video>
                // element. When the camera is active, this element will have the "active" CSS
                // class, otherwise, it will have the "inactive" class. By default, an invisible
                // element will be created to host the video.
                video: document.getElementById('preview'),
                // Whether to horizontally mirror the video preview. This is helpful when trying to
                // scan a QR code with a user-facing camera. Default true.
                mirror: true,
                // Whether to include the scanned image data as part of the scan result. See the
                // "scan" event for image format details. Default false.
                captureImage: false,
                // Only applies to continuous mode. Whether to actively scan when the tab is not
                // active.
                // When false, this reduces CPU usage when the tab is not active. Default true.
                backgroundScan: true,
                // Only applies to continuous mode. The period, in milliseconds, before the same QR
                // code will be recognized in succession. Default 5000 (5 seconds).
                refractoryPeriod: 5000,
                // Only applies to continuous mode. The period, in rendered frames, between scans. A
                // lower scan period increases CPU usage but makes scan response faster.
                // Default 1 (i.e. analyze every frame).
                scanPeriod: 1
        };

        var scanner = new Instascan.Scanner(opts);

        Instascan.Camera.getCameras().then(
            function (cameras) {
                if (cameras.length > 0) {
                    scanner.start(cameras[0]);
                } else {
                    console.error('No cameras found.');
                    alert("No cameras found.");}
                }).catch(
                        function (e) {
                            console.error(e);
                        });

        scanner.addListener('scan', function (content) {
            console.log(content);
            alert(content);
            // document.getElementById("content").innerHTML = content;

        });
    }

    var cookies1 = document.cookie;
    console.log(cookies1);
    function getCookieValue(cookieName){
        let array = cookieName.split("; ");
        for(let i=0; i < array.length; i++){
            let cookie = array[i];
            let [name,value] =  cookie.split("=");
            if (name == "session"){
                return value;
            }
        }

    }
    let sessionID = getCookieValue(cookies1);

    let skip =  document.getElementById('skipButton')
    skip.addEventListener('click',skipped);


    let question = document.getElementById('question');
    let formElement = document.getElementById('answer');


    function askForLocation(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(locationK);
        }
        else{
            alert("Geolocation is not supported by the browser");
        }
    }
    async function locationK(position) {
        let latitude = position.coords.latitude //Get the latitude
        let longitude = position.coords.longitude //Get the longitude

        await fetch("https://codecyprus.org/th/api/location?session=" + sessionID + "&latitude=" + latitude + "&longitude=" + longitude)
            .then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject);
                sessionStorage.setItem("message",jsonObject.message);
            });
    }

    setInterval(askForLocation, 30000);
    let scoreElement = document.getElementById('scoreNumber');
    async function getScore(){
        await fetch("https://codecyprus.org/th/api/score?session=" + sessionID)
            .then(response => response.json())
            .then(jsonObject => {
                scoreElement.innerText = jsonObject.score;
                sessionStorage.setItem("playerScore", jsonObject.score);
            });

    }
    let intervalId; // Declare intervalId globally
    function startTimer(duration) {
        let timerDisplay = document.getElementById('timer');
        let endTime = sessionStorage.getItem('endTime'); // Retrieve the end time from sessionStorage

        intervalId = setInterval(function () {
            let timeLeft = endTime - Date.now();

            if (timeLeft <= 0) {
                getScore();
                sessionStorage.clear();
                stopTimer();
                alert("Time is up!!");
                window.location.href = "scoreboard.html";
            }
            else {
                let minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
                let seconds = Math.floor((timeLeft / 1000) % 60);

                minutes = minutes < 10 ? '0' + minutes : minutes;
                seconds = seconds < 10 ? '0' + seconds : seconds;

                timerDisplay.textContent = minutes + ':' + seconds;
            }
        },1000);
    }

    // Set the end time in sessionStorage

    var endTime = sessionStorage.getItem('endTime');
    if(!endTime){
        let durationInMillis = parseInt(localStorage.getItem("timeOfTH"));
        sessionStorage.setItem('endTime', Date.now() + durationInMillis);
    }
    startTimer();

    let questionType;
    //receive the question information and display the question
    async function getQuestion() {
        document.getElementById('pleaseWaitMessage').style.display = 'none';
        document.getElementById('question').style.display = 'block';


        await fetch("https://codecyprus.org/th/api/question?session=" + sessionID).then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject);
                question.innerHTML = jsonObject.questionText;
                if(jsonObject.currentQuestionIndex == 0){
                    askForLocation();
                }
                if (jsonObject.requiresLocation == true) {
                    askForLocation();
                    if(sessionStorage.getItem("message") == "Ignored update as the previous update was less than 30 seconds earlier."){
                        alert("Please wait at least 30 seconds until we update your position again")
                    }
                }
                questionType = jsonObject.questionType;
                switch(questionType) {
                    case 'BOOLEAN':
                        let labelTrue = document.createElement('label');
                        let inputTrue = document.createElement('input');
                        inputTrue.type = "radio";
                        inputTrue.name = "boolean";
                        inputTrue.value = "True";
                        labelTrue.textContent = "True";
                        labelTrue.appendChild(inputTrue);

                        let labelFalse = document.createElement('label');
                        let inputFalse = document.createElement('input');
                        inputFalse.type = "radio";
                        inputFalse.name = "boolean";
                        inputFalse.value = "False";
                        labelFalse.textContent = "False";
                        labelFalse.appendChild(inputFalse);

                        document.getElementById('answerField').appendChild(labelTrue);
                        document.getElementById('answerField').appendChild(labelFalse);
                        

                        break;

                    case 'MCQ':
                        let optionA = document.createElement('input');
                        let labelA = document.createElement('label');
                        labelA.textContent = 'A';
                        optionA.type = 'radio';
                        optionA.name = 'MCQ';
                        optionA.id = 'multipleChoiceSelect';
                        optionA.value = 'A';


                        let optionB = document.createElement('input');
                        let labelB = document.createElement('label');
                        labelB.textContent = 'B';
                        optionB.type = 'radio';
                        optionB.name = 'MCQ';
                        optionB.id = 'multipleChoiceSelect';
                        optionB.value = 'B';


                        let optionC = document.createElement('input');
                        let labelC = document.createElement('label');
                        labelC.textContent = 'C';
                        optionC.type = 'radio';
                        optionC.name = 'MCQ';
                        optionC.id = 'multipleChoiceSelect';
                        optionC.value = 'C';


                        let optionD = document.createElement('input');
                        let labelD = document.createElement('label');
                        labelD.textContent = 'D';
                        optionD.type = 'radio';
                        optionD.name = 'MCQ';
                        optionD.id = 'multipleChoiceSelect';
                        optionD.value = 'D';
                        optionD.innerHTML = 'D';

                        document.getElementById('answerField').appendChild(labelA);
                        document.getElementById('answerField').appendChild(optionA);
                        document.getElementById('answerField').appendChild(labelB);
                        document.getElementById('answerField').appendChild(optionB);
                        document.getElementById('answerField').appendChild(labelC);
                        document.getElementById('answerField').appendChild(optionC);
                        document.getElementById('answerField').appendChild(labelD);
                        document.getElementById('answerField').appendChild(optionD);

                        break;
                    case 'INTEGER':
                        let inputInteger = document.createElement(('input'));
                        inputInteger.type = 'number';
                        inputInteger.id = 'inputField';
                        inputInteger.step= '1';
                        inputInteger.placeholder = "Integer only"
                        document.getElementById('answerField').appendChild(inputInteger);
                        break;
                    case 'NUMERIC':
                        let inputNumeric = document.createElement('input');
                        inputNumeric.type = 'number';
                        inputNumeric.id = 'inputField';
                        inputNumeric.step = '0.01';
                        inputNumeric.placeholder = "Decimal/Integer";
                        document.getElementById('answerField').appendChild(inputNumeric);
                        break;
                    default:
                        let inputText = document.createElement('input');
                        inputText.type = 'text';
                        inputText.id = 'inputField';
                        inputText.placeholder = "Text only";
                        // You can set additional attributes or properties for the text input here
                        document.getElementById('answerField').appendChild(inputText);
                        break;
                }
                if (jsonObject.canBeSkipped == false) {
                    skip.disabled = true;
                } else {
                    skip.disabled = false;
                }
                getScore();
            });

        }

    function stopTimer() {
        clearInterval(intervalId);
    }
    getQuestion();
    formElement.addEventListener('submit', getAnswer);
    //function to retrieve the answer and send it to the api to see if it's correct
    async function getAnswer(){
        event.preventDefault();
        document.getElementById('pleaseWaitMessage').style.display = 'block';
        document.getElementById('question').style.display = 'none';
        //prevent the submission of the form so the page doesn't reload so we don't loose the session id from the url
        let answer;
        if (questionType === 'BOOLEAN') {
            // For boolean questions, get the value of a checkbox or radio button
            answer = document.querySelector('input[name="boolean"]:checked').value;
        } else if(questionType === 'MCQ') {
            answer = document.getElementById('multipleChoiceSelect').value;
        }

        else {
            // For other types of questions, get the value from a text input field
            answer = document.getElementById('inputField').value;
        }
        //clear the answer element before appending the new inptu field
        document.getElementById('answer').innerHTML = "";
        //check if the user's answer is correct
        await fetch("https://codecyprus.org/th/api/answer?session=" + sessionID  + "&answer=" + answer)
            .then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject);
                if(jsonObject.completed == false) {
                    alert(jsonObject.message);
                    getQuestion();
                    window.location.reload();
                }
                else {
                    getScore();
                    sessionStorage.clear();
                    stopTimer();
                    alert("You have finished the quiz!!!");
                    setTimeout(function () {
                        window.location.assign("scoreboard.html");
                    }, 1000);
                }
            });
    }

    async function skipped(){
        document.getElementById('pleaseWaitMessage').style.display = 'block';
        document.getElementById('question').style.display = 'none';
        await fetch("https://codecyprus.org/th/api/skip?session=" + sessionID)
            .then(response => response.json())
            .then(jsonObject => {
                if(jsonObject.completed == false) {
                    alert(jsonObject.message);
                    getQuestion();
                    window.location.reload();
                }
                else{
                    alert("You finished the treasure hunt quiz");
                    window.location.href = "scoreboard.html";
                }
            });

    }





</script>
</body>
</html>